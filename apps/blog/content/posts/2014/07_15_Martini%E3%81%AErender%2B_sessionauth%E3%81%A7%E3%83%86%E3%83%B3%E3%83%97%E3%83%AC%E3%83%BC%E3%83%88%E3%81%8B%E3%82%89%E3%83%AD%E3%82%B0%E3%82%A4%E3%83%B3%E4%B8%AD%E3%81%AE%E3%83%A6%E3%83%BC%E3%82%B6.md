---
title: Martiniのrender+ sessionauthでテンプレートからログイン中のユーザーを取得する
date: 2014-07-15T13:14:57.000Z
id: "12921228815727009439"
draft: false
---
[martini-contrib/render](http://github.com/martini-contrib/render) と [martini-contrib/sessionauth](https://github.com/martini-contrib/sessionauth) を組み合わせて使っている時に毎回各ハンドラでユーザーをrenderに渡していた。

関係ないところは省いてあるけどこんな感じ

```go

func main() {
  m := martini.Classic()
  m.Use(sessionauth.SessionUser(GenerateAnonymousUser))
  m.Use(render.Renderer())
  m.Get("/private", GetPrivate)
  m.Run()
}

func GetPrivate(r render.Render, user sessionauth.User) {
  r.HTML(200, "private", map[string]interface{}{"User": user.(*UserModel)})
}
```

private.tmpl
```html
{{if .User.IsAuthenticated }}
ログイン済み
{{end}}
```

まぁこれでも良いのだけどいちいち書くのが面倒なのでテンプレート関数を定義してユーザーを取得できるようした。
`html/template`の機能だけどもちろん`render`から使える。

```go

func main() {
  m := martini.Classic()
  m.Use(sessionauth.SessionUser(GenerateAnonymousUser))
  // ダミーの関数を追加しておく
  m.Use(render.Renderer(render.Options{
    Funcs:  []template.FuncMap{{"currentUser": func() *UserModel { return nil }}},
  }))
  // ミドルウェアで関数を上書きする
  m.Use(func(r render.Render, u sessionauth.User) {
    r.Template().Funcs(template.FuncMap{
      "currentUser": func() *UserModel { return u.(*UserModel) },
    })
  })

  m.Get("/private", GetPrivate)
  m.Run()
}

func GetPrivate(r render.Render, user sessionauth.User) {
  r.HTML(200, "private", nil)
}
```

private.tmpl
```html
{{if currentUser.IsAuthenticated }}
ログイン済み
{{end}}
```

あまり良い方法ではない。
まずダミーの関数で名前だけを登録しておいて、次にミドルウェアとして`sessionauth`からユーザーを取り出し`render`のテンプレート関数を上書きするという動きになっている。

元ネタ
[https://github.com/martini-contrib/render/issues/3:title]
