---
title: github.com/moovweb/gokogiriを使ったコードをスタティックリンクバイナリにする
date: 2016-02-20T12:39:48.000Z
id: "10328537792364118476"
draft: true
---
goで書いたプログラムをDockerのalpineイメージ等で動かす場合はlibcとかを中に入れる必要がある。
何も考えずにビルドしないとこうなる

TODO: 普通にビルドした後のlddの結果

static binaryになるようにしてみる。
```bash
go build -a -v -installsuffix .
```
installsuffixをつけることで標準ライブラリも再度ビルドされることを利用してnetパッケージがダイナミックリンクになる現象を防いでいる。
ref: [http://tdoc.info/blog/2015/02/03/golang_static.html:title]

外部のCライブラリを使ったコードは下記のようにリンカにstaticフラグを渡してやる。

```
go build -a -v -installsuffix --ldflags '-extldflags "-static"' .
```

しかしgokogiriの場合、これは失敗してしまう。

TODO: エラーログを貼る

gokogiriが依存しているlibxml2が依存しているライブラリのシンボルが見つからない。そこでフラグを追加する。
追加すべきフラグはpkg-configで確認するよとよい。

```
pkg-config libxml-2.0 --libs --static
```

これを組み合わせて

```
go build -a -v -installsuffix --ldflags '-extldflags "-lxml2 -lz -lm -llzma -static"' .
```

となる。

```
ldd ./bin/hello
```
無事スタティックリンクバイナリになったので、libxml2を入れていないalpine等でも動くようになった。
この辺はgokogiriにpkg-configのコメントがつけば気にしなくて良くなりそう。
