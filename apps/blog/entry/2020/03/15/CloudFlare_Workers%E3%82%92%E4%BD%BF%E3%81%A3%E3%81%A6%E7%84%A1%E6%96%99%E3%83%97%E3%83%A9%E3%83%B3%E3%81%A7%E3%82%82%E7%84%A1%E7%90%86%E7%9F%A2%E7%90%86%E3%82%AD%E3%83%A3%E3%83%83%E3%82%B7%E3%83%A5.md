---
title: CloudFlare Workersを使って無料プランでも無理矢理キャッシュの出し分けを実現する
date: 2020-03-15T11:45:54.000Z
categories:
  - Web
id: "26006613535739849"
draft: false
---
originのVaryヘッダーを元にキャッシュを制御するべきだけど、あらかじめキャッシュを分けたい条件が判別できるなら、以下の方法でURLを書き換えてしまえばOK.

```typescript
import { createHash } from 'crypto'

export async function handleRequest(request: Request): Promise<Response> {
  const vary = request.headers.get('accept-language') || ''
  const varyHash = createHash('md5')
    .update(vary)
    .digest('hex')
  
  let url = new URL(request.url)
  url.searchParams.append('_vary', varyHash)
  request = new Request(url.toString(), request as RequestInit)

  return fetch(request, {
    cf: {
      cacheEverything: true,
    }
  })
}
```

まさに貧者のCDN

